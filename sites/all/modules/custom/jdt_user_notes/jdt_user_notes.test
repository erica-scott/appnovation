<?php
/**
 * @file
 * Test file for jdt_user_notes.
 */

/**
 * Include CRUD file.
 */
include_once 'jdt_user_notes.crud.inc';

/**
 * Class to test CRUD file.
 */
class JDTUserNotesCRUDTest extends DrupalWebTestCase {
  protected $priviledgedUser;

  /**
   * Provides the user interface information.
   */
  public static function getInfo() {
    $info = array(
      'name' => 'JDT User Notes CRUD Test',
      'description' => 'Asserts that JDT User Notes CRUD methods work properly',
      'group' => 'JDT User Notes',
    );

    return $info;
  }

  /**
   * Sets up the proper environment needed to run tests.
   */
  public function setUp() {
    parent::setUp(array('jdt_user_notes'));
  }

  /**
   * Tests CRUD Create function.
   */
  public function testJdtUserNotesCreate() {
    $fields = array(
      'article_nid' => 0,
      'author_uid' => 0,
      'note_text' => 'Blah blah blah',
      'note_title' => 'Test Title',
    );

    $note_id = jdt_user_notes_create($fields);
    $this->assertNotNull($note_id,
        'If insert is success, should not return null');
    $check = db_select('jdt_user_notes', 'j')
      ->fields('j')
      ->condition('note_id', $note_id, '=')
      ->execute()
      ->fetchAssoc();

    $this->assertEqual($check['article_nid'], 0);
    $this->assertEqual($check['author_uid'], 0);
    $this->assertEqual($check['note_text'], 'Blah blah blah');
    $this->assertEqual($check['note_title'], 'Test Title');
  }

  /**
   * Tests the CRUD Read functions.
   */
  public function testJdtUserNotesRead() {
    $note_id = db_insert('jdt_user_notes')
      ->fields(array(
        'article_nid' => 0,
        'author_uid' => 0,
        'note_text' => 'Blah blah blah',
        'note_title' => 'Test Title',
      ))
      ->execute();

    // Read from a specific note_id.
    $return = jdt_user_notes_read($note_id, NULL);

    $found = !empty($return);

    $this->assertTrue($found, 'Should return true because the select
     should not return an empty array');
    $this->assertEqual($return['article_nid'], 0);
    $this->assertEqual($return['author_uid'], 0);
    $this->assertEqual($return['note_text'], 'Blah blah blah');
    $this->assertEqual($return['note_title'], 'Test Title');

    $note_id = db_insert('jdt_user_notes')
      ->fields(array(
        'article_nid' => 0,
        'author_uid' => 2,
        'note_text' => 'Testing!!',
        'note_title' => 'Test Title 2',
      ))
      ->execute();

    // Adding one that shouldn't be found, as its article_nid is different.
    $note_id = db_insert('jdt_user_notes')
      ->fields(array(
        'article_nid' => 1,
        'author_uid' => 0,
        'note_text' => 'Blah blah blah',
        'note_title' => 'Test Title',
      ))
      ->execute();

    $return = jdt_user_notes_read_article(0);

    $found = !empty($return);

    $this->assertTrue($found, 'Should return true because the select
     should not return an empty array');

    $size_of_2 = (count($return) == 2);

    $this->assertTrue($size_of_2, 'Should only have two rows in array.');

    // Checks first row.
    $this->assertEqual($return[0]['article_nid'], 0);
    $this->assertEqual($return[0]['author_uid'], 0);
    $this->assertEqual($return[0]['note_text'], 'Blah blah blah');
    $this->assertEqual($return[0]['note_title'], 'Test Title');

    // Checks second row.
    $this->assertEqual($return[1]['article_nid'], 0);
    $this->assertEqual($return[1]['author_uid'], 2);
    $this->assertEqual($return[1]['note_text'], 'Testing!!');
    $this->assertEqual($return[1]['note_title'], 'Test Title 2');
  }

  /**
   * Tests the CRUD Update function.
   */
  public function testJdtUserNotesUpdate() {
    $note_id = db_insert('jdt_user_notes')
      ->fields(array(
        'article_nid' => 0,
        'author_uid' => 0,
        'note_text' => 'Blah blah blah',
        'note_title' => 'Test Title',
      ))
      ->execute();

    $new_fields = array(
      'article_nid' => 1,
      'author_uid' => 0,
      'note_text' => 'This is the changed text!',
      'note_title' => 'New Title',
    );
    $result = jdt_user_notes_update($note_id, $new_fields);

    $this->assertEqual($result, 1, 'Rows affected should = 1');
    $check = db_select('jdt_user_notes', 'j')
      ->fields('j')
      ->condition('note_id', $note_id, '=')
      ->execute()
      ->fetchAssoc();

    $this->assertEqual($check['article_nid'], 1);
    $this->assertEqual($check['author_uid'], 0);
    $this->assertEqual($check['note_text'], 'This is the changed text!');
    $this->assertEqual($check['note_title'], 'New Title');
  }

  /**
   * Tests the CRUD Delete function.
   */
  public function testJdtUserNotesDelete() {
    $note_id = db_insert('jdt_user_notes')
      ->fields(array(
        'article_nid' => 0,
        'author_uid' => 0,
        'note_text' => 'Blah blah blah',
        'note_title' => 'Test Title',
      ))
      ->execute();

    $result = jdt_user_notes_delete($note_id);

    $this->assertEqual($result, 1, 'Rows affected should = 1');
    $check = db_select('jdt_user_notes', 'j')
      ->fields('j')
      ->condition('note_id', $note_id, '=')
      ->execute()
      ->fetchAssoc();

    $found = empty($check);
    $this->assertTrue($found, 'This select should return nothing, because
     the note has been deleted');
  }

}
